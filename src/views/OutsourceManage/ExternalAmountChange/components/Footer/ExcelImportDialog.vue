<!-- eslint-disable max-len -->
<template>
  <DialogContainerComp :visible='visible' :width='680' title='批量发起金额修改' top='17vh' @cancel='visible = false' @open='onOpen'>
    <div class='dialog-content'>
      <!-- 文件上传 -->
      <div class="download">
        <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: -5px;">
          <defs>
            <pattern id="u318_img_bgp" patternUnits="userSpaceOnUse" alignment="0 0" imagerepeat="None"></pattern>
            <mask fill="white" id="u318_img_cl8">
              <path d="M 18.9453125 21.794999999999998  C 19.13561698717949 21.604999999999997  19.230769230769234 21.38  19.230769230769234 21.12  C 19.230769230769234 20.860000000000003  19.13561698717949 20.635  18.9453125 20.445  C 18.755008012820515 20.255  18.529647435897438 20.16  18.269230769230766 20.16  C 18.008814102564102 20.16  17.783453525641026 20.255  17.59314903846154 20.445  C 17.402844551282055 20.635  17.307692307692307 20.860000000000003  17.307692307692307 21.12  C 17.307692307692307 21.38  17.402844551282055 21.604999999999997  17.59314903846154 21.794999999999998  C 17.783453525641026 21.985000000000003  18.008814102564102 22.080000000000002  18.269230769230766 22.080000000000002  C 18.529647435897438 22.080000000000002  18.755008012820515 21.985000000000003  18.9453125 21.794999999999998  Z M 22.791466346153847 21.794999999999998  C 22.981770833333332 21.604999999999997  23.076923076923077 21.38  23.076923076923077 21.12  C 23.076923076923077 20.860000000000003  22.981770833333332 20.635  22.791466346153847 20.445  C 22.60116185897436 20.255  22.375801282051285 20.16  22.115384615384613 20.16  C 21.85496794871795 20.16  21.629607371794872 20.255  21.439302884615387 20.445  C 21.2489983974359 20.635  21.153846153846153 20.860000000000003  21.153846153846153 21.12  C 21.153846153846153 21.38  21.2489983974359 21.604999999999997  21.439302884615387 21.794999999999998  C 21.629607371794872 21.985000000000003  21.85496794871795 22.080000000000002  22.115384615384613 22.080000000000002  C 22.375801282051285 22.080000000000002  22.60116185897436 21.985000000000003  22.791466346153847 21.794999999999998  Z M 24.579326923076923 16.740000000000002  C 24.859775641025642 17.019999999999996  25 17.36  25 17.759999999999998  L 25 22.56  C 25 22.96  24.859775641025642 23.3  24.579326923076923 23.580000000000002  C 24.298878205128208 23.860000000000003  23.958333333333336 24  23.557692307692307 24  L 1.4423076923076923 24  C 1.0416666666666667 24  0.7011217948717949 23.860000000000003  0.4206730769230769 23.580000000000002  C 0.14022435897435895 23.3  0 22.96  0 22.56  L 0 17.759999999999998  C 0 17.36  0.14022435897435895 17.019999999999996  0.4206730769230769 16.740000000000002  C 0.7011217948717949 16.46  1.0416666666666667 16.32  1.4423076923076923 16.32  L 7.857572115384616 16.32  C 8.067908653846153 16.880000000000003  8.420973557692307 17.339999999999996  8.916766826923077 17.700000000000003  C 9.412560096153847 18.06  9.965945512820513 18.240000000000002  10.576923076923077 18.240000000000002  L 14.423076923076922 18.240000000000002  C 15.034054487179487 18.240000000000002  15.587439903846153 18.06  16.083233173076923 17.700000000000003  C 16.579026442307693 17.339999999999996  16.932091346153847 16.880000000000003  17.142427884615387 16.32  L 23.557692307692307 16.32  C 23.958333333333336 16.32  24.298878205128208 16.46  24.579326923076923 16.740000000000002  Z M 19.90685096153846 7.005  C 20.21734775641026 7.304999999999999  20.287459935897438 7.6499999999999995  20.1171875 8.04  C 19.946915064102566 8.439999999999998  19.651442307692307 8.64  19.230769230769234 8.64  L 15.384615384615385 8.64  L 15.384615384615385 15.36  C 15.384615384615385 15.619999999999997  15.289463141025642 15.844999999999999  15.099158653846153 16.035000000000004  C 14.908854166666668 16.225  14.683493589743591 16.32  14.423076923076922 16.32  L 10.576923076923077 16.32  C 10.31650641025641 16.32  10.091145833333334 16.225  9.900841346153847 16.035000000000004  C 9.71053685897436 15.844999999999999  9.615384615384617 15.619999999999997  9.615384615384617 15.36  L 9.615384615384617 8.64  L 5.769230769230769 8.64  C 5.348557692307692 8.64  5.053084935897437 8.439999999999998  4.8828125 8.04  C 4.712540064102565 7.6499999999999995  4.782652243589744 7.304999999999999  5.093149038461538 7.005  L 11.82391826923077 0.28499999999999925  C 12.00420673076923 0.09499999999999886  12.229567307692307 0  12.5 0  C 12.770432692307693 0  12.995793269230768 0.09499999999999886  13.176081730769232 0.28499999999999925  L 19.90685096153846 7.005  Z " fill-rule="evenodd"></path>
            </mask>
          </defs>
          <g transform="matrix(1 0 0 1 -276 -105 )">
            <path d="M 18.9453125 21.794999999999998  C 19.13561698717949 21.604999999999997  19.230769230769234 21.38  19.230769230769234 21.12  C 19.230769230769234 20.860000000000003  19.13561698717949 20.635  18.9453125 20.445  C 18.755008012820515 20.255  18.529647435897438 20.16  18.269230769230766 20.16  C 18.008814102564102 20.16  17.783453525641026 20.255  17.59314903846154 20.445  C 17.402844551282055 20.635  17.307692307692307 20.860000000000003  17.307692307692307 21.12  C 17.307692307692307 21.38  17.402844551282055 21.604999999999997  17.59314903846154 21.794999999999998  C 17.783453525641026 21.985000000000003  18.008814102564102 22.080000000000002  18.269230769230766 22.080000000000002  C 18.529647435897438 22.080000000000002  18.755008012820515 21.985000000000003  18.9453125 21.794999999999998  Z M 22.791466346153847 21.794999999999998  C 22.981770833333332 21.604999999999997  23.076923076923077 21.38  23.076923076923077 21.12  C 23.076923076923077 20.860000000000003  22.981770833333332 20.635  22.791466346153847 20.445  C 22.60116185897436 20.255  22.375801282051285 20.16  22.115384615384613 20.16  C 21.85496794871795 20.16  21.629607371794872 20.255  21.439302884615387 20.445  C 21.2489983974359 20.635  21.153846153846153 20.860000000000003  21.153846153846153 21.12  C 21.153846153846153 21.38  21.2489983974359 21.604999999999997  21.439302884615387 21.794999999999998  C 21.629607371794872 21.985000000000003  21.85496794871795 22.080000000000002  22.115384615384613 22.080000000000002  C 22.375801282051285 22.080000000000002  22.60116185897436 21.985000000000003  22.791466346153847 21.794999999999998  Z M 24.579326923076923 16.740000000000002  C 24.859775641025642 17.019999999999996  25 17.36  25 17.759999999999998  L 25 22.56  C 25 22.96  24.859775641025642 23.3  24.579326923076923 23.580000000000002  C 24.298878205128208 23.860000000000003  23.958333333333336 24  23.557692307692307 24  L 1.4423076923076923 24  C 1.0416666666666667 24  0.7011217948717949 23.860000000000003  0.4206730769230769 23.580000000000002  C 0.14022435897435895 23.3  0 22.96  0 22.56  L 0 17.759999999999998  C 0 17.36  0.14022435897435895 17.019999999999996  0.4206730769230769 16.740000000000002  C 0.7011217948717949 16.46  1.0416666666666667 16.32  1.4423076923076923 16.32  L 7.857572115384616 16.32  C 8.067908653846153 16.880000000000003  8.420973557692307 17.339999999999996  8.916766826923077 17.700000000000003  C 9.412560096153847 18.06  9.965945512820513 18.240000000000002  10.576923076923077 18.240000000000002  L 14.423076923076922 18.240000000000002  C 15.034054487179487 18.240000000000002  15.587439903846153 18.06  16.083233173076923 17.700000000000003  C 16.579026442307693 17.339999999999996  16.932091346153847 16.880000000000003  17.142427884615387 16.32  L 23.557692307692307 16.32  C 23.958333333333336 16.32  24.298878205128208 16.46  24.579326923076923 16.740000000000002  Z M 19.90685096153846 7.005  C 20.21734775641026 7.304999999999999  20.287459935897438 7.6499999999999995  20.1171875 8.04  C 19.946915064102566 8.439999999999998  19.651442307692307 8.64  19.230769230769234 8.64  L 15.384615384615385 8.64  L 15.384615384615385 15.36  C 15.384615384615385 15.619999999999997  15.289463141025642 15.844999999999999  15.099158653846153 16.035000000000004  C 14.908854166666668 16.225  14.683493589743591 16.32  14.423076923076922 16.32  L 10.576923076923077 16.32  C 10.31650641025641 16.32  10.091145833333334 16.225  9.900841346153847 16.035000000000004  C 9.71053685897436 15.844999999999999  9.615384615384617 15.619999999999997  9.615384615384617 15.36  L 9.615384615384617 8.64  L 5.769230769230769 8.64  C 5.348557692307692 8.64  5.053084935897437 8.439999999999998  4.8828125 8.04  C 4.712540064102565 7.6499999999999995  4.782652243589744 7.304999999999999  5.093149038461538 7.005  L 11.82391826923077 0.28499999999999925  C 12.00420673076923 0.09499999999999886  12.229567307692307 0  12.5 0  C 12.770432692307693 0  12.995793269230768 0.09499999999999886  13.176081730769232 0.28499999999999925  L 19.90685096153846 7.005  Z " fill-rule="nonzero" fill="rgba(0, 0, 0, 1)" stroke="none" transform="matrix(1 0 0 1 276 105 )" class="fill"></path>
            <path d="M 18.9453125 21.794999999999998  C 19.13561698717949 21.604999999999997  19.230769230769234 21.38  19.230769230769234 21.12  C 19.230769230769234 20.860000000000003  19.13561698717949 20.635  18.9453125 20.445  C 18.755008012820515 20.255  18.529647435897438 20.16  18.269230769230766 20.16  C 18.008814102564102 20.16  17.783453525641026 20.255  17.59314903846154 20.445  C 17.402844551282055 20.635  17.307692307692307 20.860000000000003  17.307692307692307 21.12  C 17.307692307692307 21.38  17.402844551282055 21.604999999999997  17.59314903846154 21.794999999999998  C 17.783453525641026 21.985000000000003  18.008814102564102 22.080000000000002  18.269230769230766 22.080000000000002  C 18.529647435897438 22.080000000000002  18.755008012820515 21.985000000000003  18.9453125 21.794999999999998  Z " stroke-width="0" stroke-dasharray="0" stroke="rgba(255, 255, 255, 0)" fill="none" transform="matrix(1 0 0 1 276 105 )" class="stroke" mask="url(#u318_img_cl8)"></path>
            <path d="M 22.791466346153847 21.794999999999998  C 22.981770833333332 21.604999999999997  23.076923076923077 21.38  23.076923076923077 21.12  C 23.076923076923077 20.860000000000003  22.981770833333332 20.635  22.791466346153847 20.445  C 22.60116185897436 20.255  22.375801282051285 20.16  22.115384615384613 20.16  C 21.85496794871795 20.16  21.629607371794872 20.255  21.439302884615387 20.445  C 21.2489983974359 20.635  21.153846153846153 20.860000000000003  21.153846153846153 21.12  C 21.153846153846153 21.38  21.2489983974359 21.604999999999997  21.439302884615387 21.794999999999998  C 21.629607371794872 21.985000000000003  21.85496794871795 22.080000000000002  22.115384615384613 22.080000000000002  C 22.375801282051285 22.080000000000002  22.60116185897436 21.985000000000003  22.791466346153847 21.794999999999998  Z " stroke-width="0" stroke-dasharray="0" stroke="rgba(255, 255, 255, 0)" fill="none" transform="matrix(1 0 0 1 276 105 )" class="stroke" mask="url(#u318_img_cl8)"></path>
            <path d="M 24.579326923076923 16.740000000000002  C 24.859775641025642 17.019999999999996  25 17.36  25 17.759999999999998  L 25 22.56  C 25 22.96  24.859775641025642 23.3  24.579326923076923 23.580000000000002  C 24.298878205128208 23.860000000000003  23.958333333333336 24  23.557692307692307 24  L 1.4423076923076923 24  C 1.0416666666666667 24  0.7011217948717949 23.860000000000003  0.4206730769230769 23.580000000000002  C 0.14022435897435895 23.3  0 22.96  0 22.56  L 0 17.759999999999998  C 0 17.36  0.14022435897435895 17.019999999999996  0.4206730769230769 16.740000000000002  C 0.7011217948717949 16.46  1.0416666666666667 16.32  1.4423076923076923 16.32  L 7.857572115384616 16.32  C 8.067908653846153 16.880000000000003  8.420973557692307 17.339999999999996  8.916766826923077 17.700000000000003  C 9.412560096153847 18.06  9.965945512820513 18.240000000000002  10.576923076923077 18.240000000000002  L 14.423076923076922 18.240000000000002  C 15.034054487179487 18.240000000000002  15.587439903846153 18.06  16.083233173076923 17.700000000000003  C 16.579026442307693 17.339999999999996  16.932091346153847 16.880000000000003  17.142427884615387 16.32  L 23.557692307692307 16.32  C 23.958333333333336 16.32  24.298878205128208 16.46  24.579326923076923 16.740000000000002  Z " stroke-width="0" stroke-dasharray="0" stroke="rgba(255, 255, 255, 0)" fill="none" transform="matrix(1 0 0 1 276 105 )" class="stroke" mask="url(#u318_img_cl8)"></path>
            <path d="M 19.90685096153846 7.005  C 20.21734775641026 7.304999999999999  20.287459935897438 7.6499999999999995  20.1171875 8.04  C 19.946915064102566 8.439999999999998  19.651442307692307 8.64  19.230769230769234 8.64  L 15.384615384615385 8.64  L 15.384615384615385 15.36  C 15.384615384615385 15.619999999999997  15.289463141025642 15.844999999999999  15.099158653846153 16.035000000000004  C 14.908854166666668 16.225  14.683493589743591 16.32  14.423076923076922 16.32  L 10.576923076923077 16.32  C 10.31650641025641 16.32  10.091145833333334 16.225  9.900841346153847 16.035000000000004  C 9.71053685897436 15.844999999999999  9.615384615384617 15.619999999999997  9.615384615384617 15.36  L 9.615384615384617 8.64  L 5.769230769230769 8.64  C 5.348557692307692 8.64  5.053084935897437 8.439999999999998  4.8828125 8.04  C 4.712540064102565 7.6499999999999995  4.782652243589744 7.304999999999999  5.093149038461538 7.005  L 11.82391826923077 0.28499999999999925  C 12.00420673076923 0.09499999999999886  12.229567307692307 0  12.5 0  C 12.770432692307693 0  12.995793269230768 0.09499999999999886  13.176081730769232 0.28499999999999925  L 19.90685096153846 7.005  Z " stroke-width="0" stroke-dasharray="0" stroke="rgba(255, 255, 255, 0)" fill="none" transform="matrix(1 0 0 1 276 105 )" class="stroke" mask="url(#u318_img_cl8)"></path>
          </g>
        </svg>
        <span class="text">请上传Excel文件</span>
        <input type="file" accept=".xls" @change="onFileChange" ref="onFileInput" />
      </div>

      <!-- 文字提示 -->
      <div class="tips-box is-orange">
        <p><el-icon style="font-size: 17px;"><WarningFilled /></el-icon>注意：以下外协任务无法发起金额修改！</p>
        <p>
          <span>1. 正在修改金额尚未确认的任务</span>
          <span style="margin-left: 15px;">2. 未入库或已入库超过61天的任务</span>
        </p>
      </div>
    </div>

    <template #footer>
      <div class="dialog-footer">
        <div>
          <mp-button type="primary" link @click="onTempExportClick">
            <span>下载导入模板</span> <el-icon><Download /></el-icon>
          </mp-button>
        </div>

        <mp-button class="blue" @click='visible = false'>取消</mp-button>
        <mp-button type='primary' @click='submit' style="margin-left: 25px;">确定</mp-button>
      </div>
    </template>
  </DialogContainerComp>
</template>

<script setup lang='ts'>
import api from '@/api';
import { MpMessage } from '@/assets/js/utils/MpMessage';
import DialogContainerComp from '@/components/common/DialogComps/DialogContainerComp.vue';
import { ElMessage } from 'element-plus';
import { ref } from 'vue';

const visible = defineModel<boolean>('visible');

const emit = defineEmits(['success']);

const onTempExportClick = async () => { // 下载导入模板
  const resp = await api.outsourceApis.getExternalTaskChangePriceTemplate();
  if (!resp || resp.status !== 200) {
    MpMessage.error({ title: '导出失败', msg: `[ 下载失败：${resp ? resp.statusText : '未知错误'} ]` });
    return;
  }

  const blobData = new Blob([resp.data as unknown as ArrayBuffer], { type: 'application/vnd.ms-excel' });

  const url = window.URL.createObjectURL(blobData);
  const link = document.createElement('a');
  link.style.display = 'none';
  link.href = url;

  link.setAttribute('download', '外协金额修改导入模板.xls');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  link.onload = () => {
    window.URL.revokeObjectURL(url);
  };
};

const file = ref<File | null>(null);
const onFileInput = ref<HTMLInputElement | null>(null);

const onFileChange = (event: Event) => {
  file.value = null;

  const input = event.target as HTMLInputElement;
  if (input.files && input.files.length > 0) {
    const _file = input.files[0];

    if (_file.type === 'application/vnd.ms-excel') {
      file.value = _file;
    } else {
      ElMessage.error('请选择Excel文件（.xls格式）');
      input.value = ''; // 清空文件输入
    }
  }
};

const onOpen = () => {
  file.value = null;
  if (onFileInput.value) {
    onFileInput.value.value = ''; // 清空文件输入
  }
};

const submit = async () => {
  if (!file.value) {
    ElMessage.error('请先选择Excel文件');
    return;
  }

  const resp = await api.outsourceApis.getExternalFactoryChangePriceImport(file.value);
  if (resp && resp.data?.isSuccess) {
    emit('success');
    visible.value = false;
    ElMessage.success(resp.data.Message);
  }
};

</script>

<style scoped lang='scss'>
.dialog-content {
  margin-top: -15px;
  height: 160px;

  .download {
    text-align: center;
    margin-bottom: 25px;
    margin-left: 15px;
    margin-top: 5px;
    .text {
      margin-left: 10px;
      margin-right: 18px;
    }

    input {
      font-size: 13px;
    }
  }

  .tips-box {
    width: 428px;
    height: 70px;
    font-size: 13px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
}

.dialog-footer {
  display: flex;
  align-items: center;
  margin-top: 10px;
  margin-bottom: -15px;

  > div {
    flex: 1;
    overflow: hidden;
    text-align: left;

    button {
      width: auto !important;
      font-size: 12px;
      padding: 0;

      i {
        font-size: 17px;
        font-weight: 700;
        margin-left: 4px;
      }
    }
  }

  > button {
    margin-left: 10px;
  }
}
</style>
